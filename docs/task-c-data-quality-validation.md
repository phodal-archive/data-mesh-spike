# ä»»åŠ¡ C: Data Quality Validation æ¼”ç¤º

## ğŸ¯ ç›®æ ‡
åœ¨ Airflow ç®¡é“ä¸­å®ç°"è´¨é‡å·¦ç§»"ï¼Œè®©æ•°æ®è´¨é‡æ£€æŸ¥æˆä¸ºæµæ°´çº¿çš„ä¸€éƒ¨åˆ†ï¼Œå‘ç°å¹¶é˜»æ­¢åæ•°æ®è¿›å…¥ä¸‹æ¸¸ã€‚

## ğŸ“‹ å®ç°çš„è´¨é‡è§„åˆ™

### 1. å®Œæ•´æ€§æ£€æŸ¥ (Completeness)
- âœ… **ä¸»é”®éç©ºä¸”å”¯ä¸€**: `customers.customer_id` æ—  NULL å€¼ï¼Œ10 æ¡è®°å½•å…¨éƒ¨å”¯ä¸€
- âœ… **å‚ç…§å®Œæ•´æ€§**: æ‰€æœ‰è®¢å•éƒ½æœ‰æœ‰æ•ˆçš„å®¢æˆ· IDï¼ˆæ— å­¤å„¿è®¢å•ï¼‰
- âœ… **ä¸šåŠ¡è§„åˆ™**: äº§å“ä»·æ ¼å¿…é¡»ä¸ºæ­£æ•°

### 2. ä¸€è‡´æ€§æ£€æŸ¥ (Consistency)
- âŒ **è®¢å•é‡‘é¢ä¸€è‡´æ€§**: `orders.total_amount = SUM(order_items.quantity * unit_price)`
  - **é—®é¢˜å‘ç°**: 7 ä¸ªè®¢å•çš„æ€»é‡‘é¢ä¸è®¢å•æ˜ç»†ä¸ä¸€è‡´ï¼
  - ç¤ºä¾‹:
    - è®¢å• #2: è®¢å•é‡‘é¢ $79.98 vs æ˜ç»†åˆè®¡ $109.97 (å·®å¼‚ $29.99)
    - è®¢å• #5: è®¢å•é‡‘é¢ $249.97 vs æ˜ç»†åˆè®¡ $259.97 (å·®å¼‚ $10.00)
    - è®¢å• #7: è®¢å•é‡‘é¢ $199.98 vs æ˜ç»†åˆè®¡ $179.98 (å·®å¼‚ $20.00)
- âœ… **å¤–é”®å®Œæ•´æ€§**: è®¢å•æ˜ç»†ä¸­çš„äº§å“ ID éƒ½å­˜åœ¨äºäº§å“è¡¨

### 3. æ–°é²œåº¦æ£€æŸ¥ (Freshness)
- âœ… **æ•°æ®æ—¶æ•ˆæ€§**: æœ€åè®¢å•æ—¶é—´åœ¨ 72 å°æ—¶å†… (2026-01-06 15:43:32, 10 å°æ—¶å‰)

## ğŸ“Š è´¨é‡æ£€æŸ¥ç»“æœ

```
============================================================
ğŸ“Š Quality Check Summary
============================================================
âœ“ Passed: 5/6
âœ— Failed: 1/6

âŒ Failed Checks:
  - orders.total_amount = SUM(order_items)
============================================================
```

**Pass Rate**: 83.3% (5/6)

## ğŸ”§ å®ç°ç»†èŠ‚

### ä»£ç ä½ç½®
- DAG æ–‡ä»¶: `airflow/dags/datamesh_mvp_pipeline.py`
- ä»»åŠ¡: `validate_data_quality`

### æŠ€æœ¯æ ˆ
- **æ•°æ®åº“è¿æ¥**: MySQL Connector Python
- **æŸ¥è¯¢å¼•æ“**: ç›´æ¥æŸ¥è¯¢ MariaDB å„ä¸ªåŸŸ
- **å¼‚å¸¸å¤„ç†**: å…³é”®å¤±è´¥ä¼šæŠ›å‡º `AirflowException` é˜»æ­¢ç®¡é“

### å…³é”®ç‰¹æ€§

1. **è·¨åŸŸæŸ¥è¯¢**: è¿æ¥ 4 ä¸ªæ•°æ®åŸŸè¿›è¡Œè”åˆæ£€æŸ¥
   ```sql
   -- æ£€æŸ¥è®¢å•-å®¢æˆ·å…³ç³»
   SELECT COUNT(*) FROM domain_orders.orders o
   LEFT JOIN domain_customers.customers c ON o.customer_id = c.customer_id
   WHERE c.customer_id IS NULL
   ```

2. **å…³é”®å¤±è´¥é˜»æ–­**: 
   ```python
   critical_failures = [f for f in failed_checks if 'è®¢å•æ€»é¢' in f or 'ä¸»é”®' in f]
   if critical_failures:
       raise AirflowException("å…³é”®è´¨é‡æ£€æŸ¥å¤±è´¥ï¼ç®¡é“å·²é˜»æ­¢ã€‚")
   ```

3. **ç»“æœä¼ é€’**: é€šè¿‡ XCom å°†è´¨é‡ç»“æœä¼ é€’ç»™ä¸‹æ¸¸ä»»åŠ¡
   ```python
   return {
       'passed': passed_checks,
       'failed': failed_checks,
       'pass_rate': 83.33
   }
   ```

## ğŸ“ Data Mesh å­¦ä¹ è¦ç‚¹

### è´¨é‡å·¦ç§» (Shift Quality Left)
- âœ… åœ¨æºå¤´éªŒè¯ï¼Œä¸ç­‰åˆ°æ¶ˆè´¹ç«¯å‘ç°é—®é¢˜
- âœ… æ¯ä¸ªåŸŸå¯¹è‡ªå·±çš„æ•°æ®è´¨é‡è´Ÿè´£
- âœ… è‡ªåŠ¨åŒ–æ£€æŸ¥ï¼Œä¸ä¾èµ–äººå·¥

### Data Contract (æ•°æ®å¥‘çº¦)
è¿™æ¬¡å‘ç°çš„è®¢å•é‡‘é¢ä¸ä¸€è‡´é—®é¢˜ï¼Œåº”è¯¥åœ¨ Data Contract ä¸­å®šä¹‰ï¼š
```yaml
domain: orders
data_product: orders_data_product
quality_sla:
  - rule: "total_amount = SUM(order_items)"
    level: CRITICAL
    action: BLOCK_PIPELINE
  - rule: "freshness < 24h"
    level: WARNING
    action: NOTIFY
```

### å¤±è´¥å¯è§ (Make Failures Visible)
- âœ… è¯¦ç»†æ—¥å¿—è¾“å‡º (è§ä¸Šé¢çš„æ—¥å¿—)
- âœ… å¤±è´¥è®¡æ•°å’Œå…·ä½“æ¡ˆä¾‹
- âœ… å¯é€šè¿‡ Grafana/OpenMetadata ç›‘æ§è¶‹åŠ¿

## ğŸš€ ä¸‹ä¸€æ­¥ç»ƒä¹ å»ºè®®

### ç»ƒä¹  1: ä¿®å¤æ•°æ®è´¨é‡é—®é¢˜
1. æ‰¾å‡ºä¸ºä»€ä¹ˆè®¢å•æ€»é¢ä¸ä¸€è‡´ï¼ˆå¯èƒ½æ˜¯æŠ˜æ‰£ã€è¿è´¹æœªè®¡å…¥ï¼‰
2. ä¿®æ”¹ `02-seed-more-data.sql` æˆ–æ·»åŠ ä¿®æ­£é€»è¾‘
3. é‡æ–°è¿è¡Œç®¡é“éªŒè¯

### ç»ƒä¹  2: å¢åŠ æ›´å¤šè´¨é‡è§„åˆ™
```python
# æ·»åŠ è¿™äº›æ£€æŸ¥:
- email æ ¼å¼éªŒè¯ (æ­£åˆ™è¡¨è¾¾å¼)
- è®¢å•æ—¥æœŸä¸èƒ½æ™šäºä»Šå¤©
- è®¢å•çŠ¶æ€å¿…é¡»åœ¨æšä¸¾èŒƒå›´å†… ['pending', 'shipped', 'delivered']
- å®¢æˆ·å¹´é¾„ >= 18
```

### ç»ƒä¹  3: é›†æˆåˆ° OpenMetadata
- å°†è´¨é‡è§„åˆ™é…ç½®åˆ° OpenMetadata çš„ Data Quality åŠŸèƒ½
- å¯è§†åŒ–è´¨é‡è¶‹åŠ¿
- è®¾ç½®å‘Šè­¦é˜ˆå€¼

### ç»ƒä¹  4: å®ç°æ•°æ®ä¿®å¤ (Self-Healing)
```python
if failed_checks:
    # å°è¯•è‡ªåŠ¨ä¿®å¤
    fix_order_totals()
    # é‡æ–°æ£€æŸ¥
    revalidate()
```

## ğŸ“ æ—¥å¿—æŸ¥çœ‹

æŸ¥çœ‹è¯¦ç»†æ—¥å¿—:
```bash
cat airflow/logs/dag_id=datamesh_mvp_pipeline/\
run_id=manual__2026-01-07T02:16:16.566817+00:00/\
task_id=validate_data_quality/attempt=1.log
```

## âœ… æ¼”ç¤ºå®Œæˆ

è¿™ä¸ªæ¼”ç¤ºå±•ç¤ºäº†ï¼š
1. âœ… çœŸå®çš„æ•°æ®è´¨é‡æ£€æŸ¥ï¼ˆä¸æ˜¯å‡çš„ mockï¼‰
2. âœ… å‘ç°äº†å®é™…çš„æ•°æ®é—®é¢˜ï¼ˆ7 ä¸ªè®¢å•é‡‘é¢ä¸ä¸€è‡´ï¼‰
3. âœ… æ¸…æ™°çš„æ—¥å¿—è¾“å‡ºå’Œå¤±è´¥æŠ¥å‘Š
4. âœ… å¯é…ç½®çš„å¤±è´¥é˜»æ–­ç­–ç•¥
5. âœ… Data Mesh "åŸŸè‡ªæ²» + è´¨é‡å·¦ç§»" çš„å®è·µ

**å…³é”®æ”¶è·**: Data Mesh ä¸æ˜¯ä¸è¦è´¨é‡æ£€æŸ¥ï¼Œè€Œæ˜¯è®©æ¯ä¸ªåŸŸåœ¨å‘å¸ƒæ•°æ®å‰å°±ä¿è¯è´¨é‡ï¼Œè€Œä¸æ˜¯ç­‰åˆ°æ¶ˆè´¹ç«¯æ‰å‘ç°é—®é¢˜ï¼

